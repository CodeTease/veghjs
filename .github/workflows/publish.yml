name: Publish VeghJS to NPM via OIDC

on:
  push:
    tags:
      - 'v*' # Only runs when pushing a tag (e.g., v0.2.0)

# Global variables for consistency
env:
  NODE_VERSION: 22 

permissions:
  contents: read # We rely on the committed package.json, so only read permission is needed.
  id-token: write # CRITICAL: Required for Trusted Publishing (OIDC)

jobs:
  publish-npm:
    runs-on: ubuntu-latest
    
    # CRITICAL FIX: Set the environment context for OIDC (Matching the successful template)
    environment: npm 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup Rust & WASM-Pack (To build)
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      # 2. Setup Node.js & Configure Registry
      - name: Setup Node.js & Configure Registry
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }} 
          registry-url: 'https://registry.npmjs.org'
      
      # 3. CRITICAL FIX: Update NPM to the specific, tested version (for OIDC stability)
      - name: Update NPM
        run: npm install -g npm@^11.5.1

      # 4. REMOVED THE FAULTY 'npm version' STEP. We now trust package.json.

      # 5. Clean Install Dependencies
      - name: Clean Install Dependencies (npm ci)
        run: npm ci

      # 6. Build WASM 
      - name: Build WASM (Release mode)
        run: npm run build

      # 7. Publish to NPM
      - name: Publish to NPM
        # We trust that the committed package.json contains the correct version (0.2.0)
        run: npm publish --access public
