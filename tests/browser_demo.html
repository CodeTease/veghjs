<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeghJS v0.3.0 - Viewer Demo</title>
    <style>
        :root { --primary: #2ecc71; --dark: #2c3e50; --light: #ecf0f1; --accent: #3498db; --warn: #f1c40f; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 1000px; margin: 2rem auto; padding: 0 1rem; line-height: 1.5; color: #333; }
        h1 { color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .badge { background: var(--primary); color: white; font-size: 0.5em; padding: 2px 8px; border-radius: 12px; vertical-align: middle; }
        
        /* Layout */
        .grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; margin-top: 20px; }
        .card { border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .full-width { grid-column: 1 / -1; }

        /* Controls */
        input[type="file"] { display: block; margin-bottom: 10px; width: 100%; }
        button { background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.secondary { background: var(--accent); }

        /* File List */
        #fileList { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        #fileList li { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; font-size: 0.9em; }
        #fileList li:hover { background: #f9f9f9; color: var(--accent); }
        #fileList li.active { background: #e8f6ff; border-left: 3px solid var(--accent); }
        
        /* Viewer */
        #viewerContainer { min-height: 400px; display: flex; flex-direction: column; }
        #contentView { flex: 1; background: #f8f9fa; border: 1px solid #eee; border-radius: 4px; padding: 10px; overflow: auto; position: relative; }
        pre { margin: 0; font-family: 'Consolas', monospace; font-size: 0.9em; white-space: pre-wrap; word-wrap: break-word; }
        img.preview { max-width: 100%; height: auto; display: block; margin: 0 auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .placeholder { color: #999; text-align: center; margin-top: 150px; }

        /* Logs & Metadata */
        #logs { background: var(--dark); color: var(--light); padding: 1rem; border-radius: 8px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.85em; margin-top: 20px; }
        
        /* Metadata Tags */
        #metaDisplay { display: flex; gap: 8px; flex-wrap: wrap; margin-left: auto; align-items: center; }
        .meta-tag { display: inline-flex; align-items: center; background: #eee; padding: 4px 10px; border-radius: 20px; font-size: 0.85em; color: #555; border: 1px solid #ddd; }
        .meta-tag strong { margin-right: 4px; color: #333; }
        .meta-tag.fmt-v2 { background: #e8f8f5; border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .meta-tag.fmt-v1 { background: #fef9e7; border-color: var(--warn); color: #d35400; }

        /* Utilities */
        .log-info { color: #3498db; } .log-success { color: #2ecc71; } .log-error { color: #e74c3c; }
        .progress-container { margin-top: 10px; display: none; }
        .progress-bar { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s; }
    </style>
</head>
<body>
    <h1>ü•¨ VeghJS Viewer <span class="badge">v0.3.0 FV2</span></h1>
    <p>Client-side snapshot inspection powered by <b>WebAssembly</b> & <b>Worker Threads</b>.</p>

    <!-- Upload Section -->
    <div class="card full-width">
        <input type="file" id="fileInput" accept=".snap" />
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button onclick="loadSnapshot()" id="btnLoad" disabled>üìÇ Load Snapshot</button>
            <button onclick="verifyIntegrity()" class="secondary" id="btnVerify" disabled>üõ°Ô∏è Verify Integrity (BLAKE3)</button>
            
            <!-- Metadata Dashboard -->
            <div id="metaDisplay"></div>
        </div>
        <div class="progress-container" id="progressContainer">
            <div style="font-size: 0.8em; margin-bottom: 2px;" id="progressText">Processing...</div>
            <div class="progress-bar"><div id="progress" class="progress-fill"></div></div>
        </div>
    </div>

    <div class="grid">
        <!-- File Explorer -->
        <div class="card">
            <h3 style="margin-top: 0;">üì¶ Contents <span id="fileCount" style="font-weight: normal; font-size: 0.8em; color: #888;"></span></h3>
            <ul id="fileList">
                <li style="color: #999; text-align: center; cursor: default;">No file loaded</li>
            </ul>
        </div>

        <!-- Content Viewer -->
        <div class="card" id="viewerContainer">
            <h3 style="margin-top: 0; display: flex; justify-content: space-between;">
                <span>üëÅÔ∏è Preview</span>
                <span id="currentFile" style="font-weight: normal; font-size: 0.8em; color: var(--accent);"></span>
            </h3>
            <div id="contentView">
                <div class="placeholder">Select a file to extract & view content</div>
            </div>
        </div>
    </div>

    <!-- Logs -->
    <div id="logs"></div>

    <script type="module">
        const WORKER_PATH = '../worker.js'; 
        const logDiv = document.getElementById('logs');
        let worker;
        let currentFileObj = null;

        // --- UI Helpers ---
        function log(msg, type = 'info') {
            const p = document.createElement('div');
            p.innerHTML = `<span style="opacity:0.5">[${new Date().toLocaleTimeString()}]</span> <span class="log-${type}">${msg}</span>`;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function setProgress(percent, text) {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progress');
            const txt = document.getElementById('progressText');
            
            if (percent === null) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';
            bar.style.width = `${percent}%`;
            if (text) txt.textContent = text;
        }

        // --- Worker Setup ---
        async function initWorker() {
            log('Initializing VeghJS Worker...', 'info');
            worker = new Worker(WORKER_PATH, { type: 'module' });

            worker.onmessage = (e) => {
                const { type, payload } = e.data;
                
                switch (type) {
                    case 'READY':
                        log('‚úÖ WASM Core Loaded & Ready', 'success');
                        document.getElementById('btnLoad').disabled = false;
                        break;
                    
                    case 'RESULT_METADATA':
                        renderMetadata(payload);
                        worker.postMessage({ command: 'LIST_FILES', payload: { file: currentFileObj } });
                        break;

                    case 'RESULT_FILES':
                        renderFileList(payload);
                        setProgress(null);
                        log(`Loaded ${payload.length} files structure`, 'success');
                        document.getElementById('btnVerify').disabled = false;
                        break;

                    case 'RESULT_FILE_CONTENT':
                        renderContent(payload.path, payload.data);
                        setProgress(null);
                        break;

                    case 'RESULT_INTEGRITY':
                        log(`‚ú® Integrity Check Passed! BLAKE3 Hash: <b>${payload}</b>`, 'success');
                        setProgress(null);
                        break;

                    case 'PROGRESS':
                        setProgress(payload.progress, `Verifying Integrity... ${payload.progress.toFixed(1)}%`);
                        break;

                    case 'ERROR':
                        log(`‚ùå Error: ${payload}`, 'error');
                        setProgress(null);
                        break;
                }
            };
        }

        // --- Core Functions ---

        window.loadSnapshot = () => {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) return alert("Select a .snap file first!");
            
            currentFileObj = fileInput.files[0];
            
            // UI Reset
            document.getElementById('fileList').innerHTML = '<li style="padding:20px; text-align:center">Loading...</li>';
            document.getElementById('contentView').innerHTML = '<div class="placeholder">Loading...</div>';
            document.getElementById('metaDisplay').innerHTML = ''; // Clear meta
            setProgress(0, "Reading Metadata...");

            worker.postMessage({ command: 'GET_METADATA', payload: { file: currentFileObj } });
        };

        window.verifyIntegrity = () => {
            if (!currentFileObj) return;
            log('Starting Integrity Check (BLAKE3)...', 'info');
            setProgress(0, "Starting Stream...");
            worker.postMessage({ 
                command: 'CHECK_INTEGRITY_STREAM', 
                payload: { file: currentFileObj, chunkSize: 1024 * 1024 * 5 } 
            });
        };

        window.extractFile = (path) => {
            log(`Extracting: ${path}...`, 'info');
            document.getElementById('contentView').innerHTML = '<div class="placeholder">Extracting...</div>';
            document.getElementById('currentFile').textContent = path;
            
            document.querySelectorAll('#fileList li').forEach(li => li.classList.remove('active'));
            document.getElementById(`file-${path.replace(/\W/g, '_')}`).classList.add('active');

            worker.postMessage({
                command: 'GET_FILE_CONTENT',
                payload: { file: currentFileObj, path: path }
            });
        };

        // --- Renderers ---

        function renderMetadata(meta) {
            const div = document.getElementById('metaDisplay');
            
            // Fallback for timestamps (PyVegh compatibility)
            let timeStr = meta.timestamp_human;
            if (!timeStr) {
                timeStr = new Date(meta.timestamp * 1000).toLocaleString();
            }

            // Ensure Format Version is displayed correctly
            // Default to "1" if missing (Legacy)
            const fmtVer = meta.format_version || '1';
            const fmtClass = fmtVer === '2' ? 'fmt-v2' : 'fmt-v1';

            div.innerHTML = `
                <span class="meta-tag"><strong>üë§ Author:</strong> ${meta.author}</span>
                <span class="meta-tag"><strong>üìÖ Created:</strong> ${timeStr}</span>
                <span class="meta-tag"><strong>üõ†Ô∏è Tool:</strong> ${meta.tool_version}</span>
                <span class="meta-tag ${fmtClass}"><strong>üìÑ Format:</strong> v${fmtVer}</span>
                ${meta.comment ? `<span class="meta-tag" title="${meta.comment}"><strong>üí¨ Note:</strong> ${meta.comment.substring(0, 15)}...</span>` : ''}
            `;
            log(`Metadata: Author=${meta.author}, Tool=${meta.tool_version}, Format=v${fmtVer}`, 'info');
        }

        function renderFileList(files) {
            const ul = document.getElementById('fileList');
            document.getElementById('fileCount').textContent = `(${files.length})`;
            ul.innerHTML = '';
            files.sort((a, b) => a.path.localeCompare(b.path));

            files.forEach(f => {
                const li = document.createElement('li');
                li.id = `file-${f.path.replace(/\W/g, '_')}`;
                li.innerHTML = `
                    <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-right:10px;" title="${f.path}">
                        ${f.path.endsWith('/') ? 'üìÅ' : 'üìÑ'} ${f.path}
                    </span>
                    <span style="color:#999; font-size:0.85em;">${formatBytes(f.size)}</span>
                `;
                li.onclick = () => extractFile(f.path);
                ul.appendChild(li);
            });
        }

        function renderContent(path, uint8Array) {
            const viewer = document.getElementById('contentView');
            const size = formatBytes(uint8Array.length);
            log(`Extracted ${path} (${size})`, 'success');

            const ext = path.split('.').pop().toLowerCase();
            
            if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'].includes(ext)) {
                const blob = new Blob([uint8Array], { type: `image/${ext === 'svg' ? 'svg+xml' : ext}` });
                const url = URL.createObjectURL(blob);
                viewer.innerHTML = `<img src="${url}" class="preview" alt="${path}">`;
                return;
            }

            let isBinary = false;
            for (let i = 0; i < Math.min(uint8Array.length, 100); i++) {
                if (uint8Array[i] === 0) { isBinary = true; break; }
            }

            if (isBinary) {
                viewer.innerHTML = `
                    <div class="placeholder">
                        ‚ö†Ô∏è Binary File (${size})<br>
                        <button style="margin-top:10px" onclick="downloadBlob('${path}')">Download to View</button>
                    </div>`;
                window.tempBlob = new Blob([uint8Array], { type: 'application/octet-stream' });
            } else {
                const text = new TextDecoder().decode(uint8Array);
                const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                viewer.innerHTML = `<pre>${safeText}</pre>`;
            }
        }

        window.downloadBlob = (filename) => {
            if (!window.tempBlob) return;
            const url = URL.createObjectURL(window.tempBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename.split('/').pop();
            a.click();
        };

        document.getElementById('fileInput').addEventListener('change', function() {
            if (this.files.length > 0 && worker) {
                document.getElementById('btnLoad').disabled = false;
            }
        });

        initWorker();
    </script>
</body>
</html>